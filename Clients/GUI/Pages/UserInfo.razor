@page "/userinfo"
@inject NavigationManager NavManager
@inject IModalService Modal
@inject ISessionStorageService Storage
@attribute [Authorize]
@{ 

}
    <div class="wrapper">

        <div align="center" class="h3" min-width:>
            <h3><b>User Info</b></h3>
        </div>
        <nav>
            <ul class="top-menu" align =" center">
                <li><a href="#">Personal Information</a></li>
                <li><a href="#">Transaction History</a></li>
            </ul>
        </nav>
        <div class="row">
        <div class="col-sm-4" align =" center">
            <EditForm Model="@user">
                <p><img src=@imgSrc style="max-width:200px; max-height:200px;"  alt="Avatar"></p>
            </EditForm>
        </div>
        <div class=" = col-sm-8">
            <EditForm Model="@user" >
                <DataAnnotationsValidator />
                <div class="form-group" >
                    <label for="Name">Name:</label>
                    <InputText class="form-control col-3" disabled="@IsEditModeDisabled" @bind-Value="user.FirstName" />
                </div>
                <div class="form-group">
                    <label for="Surname">Surname:</label>
                    <InputText class="form-control col-3" disabled="@IsEditModeDisabled" @bind-Value="user.LastName" />
                </div>
                <div class="form-group">
                    <label for="Birthday">Birthday:</label>
                    <InputDate class="form-control col-3" disabled="@IsEditModeDisabled" @bind-Value="@user.Birthday" />
                </div>
                <div class="form-group">
                    <label for="Email">Email:</label>
                    <InputText class="form-control col-3" disabled="true" @bind-Value="@user.Email" />
                </div>
                <div class="form-group" style="@(IsPasswordBeingChanged ? "" : "height: 0; color: transparent")">
                    <label for="OldPassword">Enter old password: </label>
                    <InputText type="@(IsPasswordBeingChanged ? "password" : "hidden")" class="@InputStyleClass" disabled="@(!IsPasswordBeingChanged)" @bind-Value="@user.OldPassword" />
                </div>
                <div class="form-group" style="@(IsPasswordBeingChanged ? "" : "height: 0; color: transparent")">
                    <label for="NewPassword">Enter new password: </label>
                    <InputText type="@(IsPasswordBeingChanged ? "password" : "hidden")" class="@InputStyleClass" disabled="@(!IsPasswordBeingChanged)" @bind-Value="@user.NewPassword" />
                </div>
                <br />
                <input type="@(IsEditModeDisabled ? "hidden" : "button")" @onclick="@ChangePasswordClickHandler" class="form-control col-3 button btn-primary" value="@(IsPasswordBeingChanged ? "Cancel changing password" : "Change password")" />
                <br />
                <ValidationSummary />
                <h4 style="display:@(ErrorOccured ? "block" : "hidden"); color:red">@ErrorMessage</h4>
                <input type="button" @onclick="@EditInfoClickHandler" class="form-control col-3 button btn-primary" value="@(IsEditModeDisabled ? "Edit" : "Save changes")" />
            </EditForm>
        </div>
    </div>
        </div>

        @code {
            public bool IsEditModeDisabled { get; set; }
            public bool IsPasswordBeingChanged { get; set; }
            public bool PopupVisible { get; set; }
            public string ErrorMessage { get; set; }
            public string InputStyleClass { get; set; }
            public bool ErrorOccured { get; set; }
            private UserInfoViewModel user;
            private UserToken userToken;
            public string imgSrc = "~/images/withoutAvatar.png";


            private async Task EditInfoClickHandler()
            {
                if (IsEditModeDisabled)
                {
                    IsEditModeDisabled = false;
                    InputStyleClass = "form-control col-3";
                }
                else
                {
                    try
                    {
                        var userInfo = new UserInfoRequest()
                        {
                            UserId = userToken.UserId,
                            Email = user.Email,
                            FirstName = user.FirstName,
                            LastName = user.LastName,
                            Birthday = user.Birthday
                        };

                        var request = new EditUserRequest()
                        {
                            UserInfo = userInfo,
                            PasswordRequest = null
                        };

                        if (IsPasswordBeingChanged)
                        {
                            var passwordRequest = new PasswordChangeRequest()
                            {
                                OldPassword = user.OldPassword,
                                NewPassword = user.NewPassword
                            };

                            request.PasswordRequest = passwordRequest;
                        }

                        await UserEditor.EditUser(userToken, request);

                        await UpdateUserModel();
                    }
                    catch (Exception e) when (
                        e is ForbiddenException ||
                        e is NotFoundException ||
                        e is ValidationException)
                    {
                        ErrorMessage = e.Message;
                        ErrorOccured = true;
                    }

                    Modal.Show<Modals.ChangesSavedModal>("Changes saved");
                    IsEditModeDisabled = true;
                    IsPasswordBeingChanged = false;
                }
            }

            private void ChangePasswordClickHandler()
            {
                IsPasswordBeingChanged ^= true;
            }

            private async Task UpdateUserModel()
            {
                try
                {
                    var path = System.IO.Directory.GetCurrentDirectory();
                    imgSrc = path + "\\wwwroot\\images\\withoutAvatar.png";
                    var requestResult = await UserGetter.GetUserById(userToken);

                    user = new UserInfoViewModel()
                    {
                        FirstName = requestResult.FirstName,
                        LastName = requestResult.LastName,
                        Birthday = requestResult.Birthday,
                        Email = requestResult.Email,
                        Avatar = requestResult.Avatar,
                        AvatarExtension = requestResult.AvatarExtension

                    };
                    if (user.Avatar != null)
                        imgSrc = GetSrcImage(user.Avatar, user.AvatarExtension);
                    else
                        imgSrc = GetDefaultImage(imgSrc);


                }
                catch (NotFoundException)
                {
                    ErrorMessage = "Unable to get user information";
                }
                catch (Exception)
                {
                    ErrorMessage = "Error occured";
                    ErrorOccured = true;
                }
            }

            private string GetSrcImage(byte[] avatar, string extension)
            {
                var base64 = Convert.ToBase64String(avatar);
                return String.Format("data:image/{0};base64,{1}", extension, base64);

            }
            private string GetDefaultImage(string src)
            {

                var file = File.ReadAllBytes(src);
                var ext = src.Substring(src.IndexOf('.') + 1, 3);
                var base64 = Convert.ToBase64String(file);
                return String.Format("data:image/{0};base64,{1}", ext, base64);
            }

            protected override void OnInitialized()
            {
                userToken = new UserToken();
                user = new UserInfoViewModel();
                ErrorOccured = false;
                ErrorMessage = "";
                PopupVisible = false;
                IsEditModeDisabled = true;
                IsPasswordBeingChanged = false;
                InputStyleClass = "input-group-text";
            }

            protected override async Task OnAfterRenderAsync(bool firstRender)
            {
                userToken.UserId = await Storage.GetItemAsync<Guid>("id");
                userToken.Body = await Storage.GetItemAsync<string>("token");

                if (IsEditModeDisabled && string.IsNullOrEmpty(user.FirstName))
                {
                    await UpdateUserModel();
                    StateHasChanged();
                }
            }
        }

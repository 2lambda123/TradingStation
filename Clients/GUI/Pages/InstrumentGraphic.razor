@page "/instrument/{Figi}"
@using System.Timers
@using ChartJs.Blazor.ChartJS
@using ChartJs.Blazor.ChartJS.Common.Axes
@using ChartJs.Blazor.ChartJS.Common.Axes.Ticks
@using ChartJs.Blazor.ChartJS.Common.Enums
@using ChartJs.Blazor.ChartJS.Common.Handlers
@using ChartJs.Blazor.ChartJS.Common.Properties
@using ChartJs.Blazor.ChartJS.Common.Time
@using ChartJs.Blazor.ChartJS.LineChart
@using ChartJs.Blazor.Charts
@using DTO.BrokerRequests
@using Microsoft.AspNetCore.SignalR.Client
@inject NavigationManager NavigationManager
@inject ISessionStorageService Storage
@inject IJSRuntime JsRuntime

<h1>@errorMessage</h1>
<ChartJsLineChart @ref="lineChartJs" Config="@lineConfig" Width="600" Height="300" />

@code {

    [Parameter]
    public string Figi { get; set; }

    public HubConnection hubConnection;
    private string errorMessage = "";
    private Timer timer;
    private string Name;
    private string token = "";
    private ChartJsLineChart lineChartJs;
    private LineConfig lineConfig;
    private LineDataset<TimeTuple<decimal>> tempDataSet;
    private bool localeChangeWasAttempted = false;
    private DateTime lasTime;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            token = await Storage.GetItemAsync<string>("tinkoffToken");
            if (token == null)
            {
                errorMessage = "Access error";
                StateHasChanged();
                return;
            }

            hubConnection = new HubConnectionBuilder()
                .WithUrl("https://localhost:5009/CandleHub")
                .Build();

            hubConnection.On<Candle>("ReceiveMessage", Candle =>
            {
                if (lasTime == null || lasTime != Candle.Time)
                {
                    lasTime = Candle.Time;
                    tempDataSet.Add(new TimeTuple<decimal>(new Moment(Candle.Time), Candle.Close));
                    lineConfig.Data.Datasets.Add(tempDataSet);
                    lineChartJs.Update();
                } 

                timer.Stop();
                timer.Dispose();
            });

            await hubConnection.StartAsync();

            await hubConnection.SendAsync("Subscribe", new SubscribeOnCandleRequest
            {
                Token = token,
                Broker = BrokerType.TinkoffBroker,
                Figi = Figi
            });

            timer = new Timer(8000);
            timer.Elapsed += OnTimedEvent;
            timer.AutoReset = false;
            timer.Start();
        }
    }

    protected override void OnInitialized()
    {
        SetChartConfig();
    }

    private void SetChartConfig()
    {
        lineConfig = new LineConfig
        {
            Options = new LineOptions
            {
                Responsive = true,
                Title = new OptionsTitle
                {
                    Display = true,
                    Text = "Instrument Name"
                },
                Legend = new Legend
                {
                    Position = Position.Right,
                    Labels = new LegendLabelConfiguration
                    {
                        UsePointStyle = true
                    }
                },
                Tooltips = new Tooltips
                {
                    Mode = InteractionMode.Nearest,
                    Intersect = false
                },
                Scales = new Scales
                {
                    xAxes = new List<CartesianAxis>
                {
                        new TimeAxis
                        {
                            Distribution = TimeDistribution.Linear,
                            Ticks = new TimeTicks
                            {
                                Source = TickSource.Data
                            },
                            Time = new TimeOptions
                            {
                                Unit = TimeMeasurement.Minute,
                                Round = TimeMeasurement.Minute,
                                TooltipFormat = "DD.MM.YYYY HH:mm",
                                DisplayFormats = TimeDisplayFormats.DE_CH
                            }
                        }
                    }
                },
                Hover = new LineOptionsHover
                {
                    Intersect = true,
                    Mode = InteractionMode.Y
                }
            }
        };

        tempDataSet = new LineDataset<TimeTuple<decimal>>
        {
            Fill = false,
            BorderWidth = 2,
            PointRadius = 3,
            PointBorderWidth = 1,
            SteppedLine = SteppedLine.False
        };
    }

    private void OnTimedEvent(object source, ElapsedEventArgs e)
    {
        errorMessage = "Instrument not found";
        hubConnection.StopAsync().Wait();
        timer.Stop();
        timer.Dispose();
    }
}